---

- name: check that group {{ cassandra_cluster_group_name }} is not empty
  fail: msg="Your {{'{{'}} cassandra_cluster_group_name {{ '}}' }} is set to '{{ cassandra_cluster_group_name }}' and has {{ groups[cassandra_cluster_group_name]|count }} hosts, at least 1 is required"
  when: groups[cassandra_cluster_group_name]|count < 1


- name: apt-get update
  apt:
    update_cache: yes
    cache_valid_time: 300
  ignore_errors: True

- name: install required packages
  apt: name={{ item }} state=latest
  with_items:
    - runit
    - curl

- name: find out version of the latest release
  shell: curl -s http://cassandra.apache.org/|grep "{{ 'Latest' if cassandra_version == "latest" else 'Stable' }} release" |sed -E 's/\s+{{ 'Latest' if cassandra_version == 'latest' else 'Stable' }}\srelease\s<b>([0-9.]+)<\/b>.*/\1/'
  register: result
  when: cassandra_version in ["latest", "stable"]
  tags: always

- name: get checksum
  uri: url=http://www.apache.org/dist/cassandra/{{ result.stdout }}/apache-cassandra-{{ result.stdout }}-bin.tar.gz.sha1 return_content=yes
  register: checksum
  when: cassandra_version in ["latest", "stable"]
  tags: always

- name: define cassandra version if it is set to latest, also set checksum
  set_fact:
      cassandra_version: "{{ result.stdout }}"
      cassandra_version_sha1: "{{ checksum.content }}"
  when: cassandra_version in ["latest", "stable"]
  tags: always

- name: download
  get_url: dest="/tmp/apache-cassandra-{{ cassandra_version }}-bin.tar.gz" url="http://apache-mirror.rbc.ru/pub/apache/cassandra/{{ cassandra_version }}/apache-cassandra-{{ cassandra_version }}-bin.tar.gz"

- name: checksumming cassandra
  shell: echo "{{ cassandra_version_sha1 }} /tmp/apache-cassandra-{{ cassandra_version }}-bin.tar.gz" | sha1sum -c -
  when: cassandra_version not in ["latest", "stable"]

- name: create all the necessary dirs
  file: path=/{{ item }} state=directory
  with_items:
    - sv/cassandra/log
    - "{{ cassandra_path_install }}"
    - "{{ cassandra_path_logs }}"
    - "{{ cassandra_path_caches }}"

- name: create all the necessary dirs
  file: path=/{{ item }} state=directory
  with_items: cassandra_path_data

- name: unpack
  unarchive: src="/tmp/apache-cassandra-{{ cassandra_version }}-bin.tar.gz" dest="{{ cassandra_path_install }}" copy=no

- name: remove archive
  file: path="/tmp/apache-cassandra-{{ cassandra_version }}-bin.tar.gz" state=absent

- name: remove old install
  file: path="{{ cassandra_path_install }}/cassandra" state=absent

- name: update symlink
  file: src="apache-cassandra-{{ cassandra_version }}" dest="{{ cassandra_path_install }}/cassandra" state=link

- name: create user
  user: name="{{ cassandra_user }}" comment="cassandra run user" home="{{ cassandra_path_install }}" createhome=no

- name: make all the file RO
  file: path="{{ cassandra_path_install }}" owner="{{ cassandra_user }}" group='root' mode="a-w" recurse=yes

- name: make some dirs RW
  file: path="{{ item }}" owner="{{ cassandra_user }}" group='root' mode="u+w" recurse=yes
  with_items:
    - "{{ cassandra_path_logs }}"
    - "{{ cassandra_path_caches }}"

- name: make some dirs RW
  file: path="{{ item }}" owner="{{ cassandra_user }}" group='root' mode="u+w" recurse=yes
  with_items: cassandra_path_data

- name: upload configs and scripts
  template: src="{{ item.name }}" dest="{{ item.dest if item.dest is defined else cassandra_path_install + '/' + item.name }}" owner="{{ item.user if item.user is defined else 'root' }}" group="{{ item.group if item.group is defined else 'root' }}" mode="{{ item.mode if item.mode is defined else '0644' }}"
  with_items:
    - { name: "cassandra/conf/cassandra.yaml", mode: "0640", user: "{{ cassandra_user }}" }
    - { name: "cassandra/conf/logback.xml", mode: "0440", user: "{{ cassandra_user }}" }
    - { name: "cassandra/conf/cassandra-topology.properties", mode: "0440", user: "{{ cassandra_user }}" }
    - { name: "cassandra-autoconfig", mode: "0755", dst: "{{ cassandra_path_install }}/{{ cassandra_start }}" }

- name: wait for port availability
  wait_for: host={{ hostvars[inventory_hostname]['ansible_' + cassandra_node_iface_int]['ipv4']['address'] }} port=9042 delay=5 timeout=60
  register: check
  ignore_errors: yes

- name: print check status
  debug: var=check

- name: fail if conection failed
  fail: >
        msg="Connection failed to {{ hostvars[inventory_hostname]['ansible_' + cassandra_node_iface_int]['ipv4']['address'] }}:9043. Please
        check '/var/log/cassandra/current' log file and try to run
        '{{ cassandra_path_install }}/cassandra/bin/cqlsh
        {{ hostvars[inventory_hostname]['ansible_' + cassandra_node_iface_int]['ipv4']['address'] }}'"
  when: check.failed is defined and check.failed
